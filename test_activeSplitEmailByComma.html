<!DOCTYPE html>
<html>
    <head>
        <script src="./jquery.min.js"></script>
        <style>
            textarea {
                width: 600px;
                height: 200px;
            }
        </style>
    </head>
    <body>
        <textarea id='input'></textarea>
        <br/>
        <input type='button' value='test'/>
        <div id='output'></div>
        <script>
            $(document).ready(function(){
                var input_list = [
                    '"test, atmail" <testatmail@twofive25.com>, testatmail@twofive25.com, "testatmail0000001@twofive25.com" <testatmail0000001@twofive25.com>, "test, atmail, 0000002" <testatmail0000002@twofive25.com>, test,atmail@twofive25.com',
                    '"first, <test@example.com>, \'test\', last" <test1@example.com>, user1,user2@example.com, user1,user2,user3@twofive25.com',
                    '"user1@twofive.xyz <kase@twofive25.com>" <kase@twofive25.com>',
                    '"first, <test@example.com>, last" <test@example.com>',
                    '"test, atmail" <testatmail@twofive25.com>, "test, atmail, 1" <testatmail0000001@twofive25.com>, "test, atmail, 2" <testatmail0000002@twofive25.com>, testatmail <testatmail0000003@twofive25.com>',
                    '"first, <test@example.com>, last" <test@example.com>, test@example.com',
                    '"加瀬,正樹" <user4@twofive.xyz>, test@example.com',
                    '"first, <test@example.com>, "test", last" <test1@example.com>, test2@example.com',
                    '"first, <test@example.com>, last" <test1@example.com>, test2@example.com',
                    '"user1,user2"@example.com',
                    '"first, <test@example.com>, "test", last" <"test"1@example.com>, "user1,user2"@example.com',
                    'user1@example.com',
                    '"test, atmail" <testatmail@twofive25.com>,testatmail@twofive25.com,"testatmail0000001@twofive25.com" <testatmail0000001@twofive25.com>,"test, atmail, 0000002" <testatmail0000002@twofive25.com>,test,atmail@twofive25.com',
                    '"first, <test@example.com>, \'test\', last" <test1@example.com>, user1,user2@example.com, user1,user2,user3@twofive25.com',
                    '<user1@twofive.xyz>,<user2@twofive.xyz>,user3@twofive.xyz',
                    '"TwoFive,Inc." <softest@nifty.com>,"TwoFive,Inc."<softest@nifty.com>',
                    '"TwoFive, Inc." <softest@nifty.com>,"TwoFive, Inc."<softest@nifty.com>',
                    '"Two,Five,Inc." <softest@nifty.com>,"Two,Five,Inc."<softest@nifty.com>',
                    '"Masaki Kase <kase@twofive25.com>" <softest@nifty.com>,"Masaki Kase <kase@twofive25.com>"<softest@nifty.com>',
                    '"Masaki Kase<kase@twofive25.com>" <softest@nifty.com>,"Masaki Kase<kase@twofive25.com>"<softest@nifty.com>',
                    '<"softest"@nifty.com>',
                    '<"softest."@nifty.com>',
                    '<"sof..test"@nifty.com>',
                    '<"user1,user2"@twofive.xyz>',
                    '<test,1@example1.com>,test,2@example2.com',
                    '<test,1@example1.com>,test,2@example2.com,test,3@example3.com',
                    'test,1@example1.com,test,2@example2.com',
                    'test,1@example1.com, test,2@example2.com',
                    'test,1@example1.com,,,,test,2@example2.com',
                    '""test, 2" <test2@example2.com>" <test1@example1.com>',
                    'test@example.com,""test, 2" <test2@example2.com>" <test1@example1.com>',
                    '',
                ];

                var input_string = ''
                for (var i = 0; i < input_list.length; i++) {
                    if (i < input_list.length - 1) {
                        input_string = input_string.concat(input_list[i]).concat('\n');
                    } else {
                        input_string = input_string.concat(input_list[i]);
                    }
                }
                $('textarea#input').val(input_string);

                $('input[type="button"]').on('click', function(e){
                    e.preventDefault();
                    input_list = $('textarea#input').val().split('\n');
                    $('div').html('');
                    for (var i = 0; i < input_list.length; i++) {
                        if (input_list[i].trim() != '') {
                            $('div#output').append($('<div>').append($('<pre>').text(input_list[i])));
                            var results = activeSplitEmailByComma(input_list[i]);
                            for (var j = 0; j < results.length; j++) {
                                if (j == 0) {
                                    $('div#output').append($('<div>').append($('<pre>').text('=> '.concat(results[j]))));
                                } else {
                                    $('div#output').append($('<div>').append($('<pre>').text('   '.concat(results[j]))));
                                }
                            }
                            if (i != input_list.length - 1) {
                                $('div#output').append($('<br>'));
                            }
                        }
                    }
                    return false;
                });

                String.prototype.replaceAt=function(index, replacement) {
                    return this.substr(0, index) + replacement+ this.substr(index + replacement.length);
                }

                function removeStringAndFollowingComma(raw_string, string_list) {
                    var string_to_process = raw_string;
                    for (var i = 0; i < string_list.length; i++) {
                        var string_to_process_first_part = '';
                        var string_to_process_second_part = '';

                        string_to_process_first_part = string_to_process.substring(
                                                            0,
                                                            string_to_process.indexOf(string_list[i])
                                                       );

                        var start_of_second_part = string_to_process.indexOf(string_list[i]) + string_list[i].length;
                        for (var j = start_of_second_part; j < string_to_process.length; j++) {
                            if (string_to_process[j] == ' ') {
                                continue;
                            } else if (string_to_process[j] == ',') {
                                string_to_process = string_to_process.replaceAt(j, ' ');
                                start_of_second_part = j;
                                break;
                            } else {
                                // TODO: If we're here that means there is something wrong
                                // with code or input string
                            }
                        }
                        string_to_process_second_part = string_to_process.substring(start_of_second_part, string_to_process.length);

                        string_to_process = string_to_process_first_part.concat(string_to_process_second_part);
                    }
                    return string_to_process;
                }

                function activeSplitEmailByComma(stringRaw)
                {
                    var name_email_pattern = /".*"\s*<[a-zA-Z0-9!#$%&'*+\-=?^_`{|}~@\.\[\],"]+@[a-zA-Z0-9_\-\.]+>/g;
                    var enclosed_email_pattern = /<[a-zA-Z0-9!#$%&'*+\-=?^_`{|}~@\.\[\],"]+@[a-zA-Z0-9_\-\.]+>/g;
                    var email_pattern = /[a-zA-Z0-9!#$%&'*+\-=?^_`{|}~@\.\[\],"]+@[a-zA-Z0-9_\-\.]+/g;

                    if( stringRaw == undefined || typeof(stringRaw) != 'string') {
                        return new Array('');
                    } else if (stringRaw == '') {
                        return Array('');
                    } else {
                        // Split by comma first
                        string_splitted_by_comma = stringRaw.split(',');
                        if (string_splitted_by_comma.length > 0) {
                            // Find "display-name" <local-part@domain-part>
                            var name_email_list = [];
                            // We're going to find all parts in format "xxx" <yyy@zzz>
                            // If the raw string is not in that format, we will skip
                            if (stringRaw.match(name_email_pattern) != null) {
                                for (var i = 0; i < string_splitted_by_comma.length; i++) {
                                    var match_array = string_splitted_by_comma[i].match(name_email_pattern);
                                    if (match_array == null) {
                                        for (var j = i + 1; j < string_splitted_by_comma.length; j++) {
                                            var string_to_process = '';
                                            for (var k = i; k <= j; k++) {
                                                if (k == i) {
                                                    string_to_process = string_to_process.concat(string_splitted_by_comma[k]);
                                                } else {
                                                    string_to_process = string_to_process.concat(',').concat(string_splitted_by_comma[k]);
                                                }
                                            }
                                            match_array = string_to_process.match(name_email_pattern);
                                            if (match_array != null) {
                                                i = j + 1;
                                                for (var k = 0; k < match_array.length; k++) {
                                                    name_email_list.push(match_array[k]);
                                                }
                                            }
                                        }
                                    } else {
                                        for (var k = 0; k < match_array.length; k++) {
                                            name_email_list.push(match_array[k]);
                                        }
                                    }
                                }
                            }

                            // FIXME: We expect that the list containing display name and email address above
                            // is correct so we will remove them from input string to continue extracting
                            // email addresses
                            var string_to_process = removeStringAndFollowingComma(stringRaw, name_email_list);
                            // Find <local-part@domain-part>
                            var enclosed_email_list = string_to_process.match(enclosed_email_pattern);
                            if (enclosed_email_list == null) {
                                enclosed_email_list = [];
                            }

                            // Remove enclosed email list from input string to continue extracting email address
                            string_to_process = removeStringAndFollowingComma(string_to_process, enclosed_email_list);
                            // Find "display-name" <local-part@domain-part>
                            var email_list = [];
                            // Split by comma first
                            string_splitted_by_comma = string_to_process.split(',');
                            if (string_splitted_by_comma.length > 0) {
                                if (string_to_process.match(email_pattern) != null) {
                                    for (var i = 0; i < string_splitted_by_comma.length; i++) {
                                        var match_array = string_splitted_by_comma[i].match(email_pattern);
                                        if (match_array == null) {
                                            for (var j = i + 1; j < string_splitted_by_comma.length; j++) {
                                                var string_to_process = '';
                                                for (var k = i; k <= j; k++) {
                                                    if (k == i) {
                                                        string_to_process = string_to_process.concat(string_splitted_by_comma[k]);
                                                    } else {
                                                        string_to_process = string_to_process.concat(',').concat(string_splitted_by_comma[k]);
                                                    }
                                                }
                                                match_array = string_to_process.match(email_pattern);
                                                if (match_array != null) {
                                                    i = j + 1;
                                                    for (var k = 0; k < match_array.length; k++) {
                                                        email_list.push(match_array[k]);
                                                    }
                                                }
                                            }
                                        } else {
                                            for (var k = 0; k < match_array.length; k++) {
                                                email_list.push(match_array[k]);
                                            }
                                        }
                                    }
                                }
                            }

                            // Remove '<' and '>' in enclosed email
                            for (var i = 0; i < enclosed_email_list.length; i++) {
                                var record = enclosed_email_list[i].trim();
                                if (record.indexOf('<') == 0 && record.lastIndexOf('>') == (record.length - 1)) {
                                    enclosed_email_list[i] = record.substring(1, record.length - 1);
                                }
                            }

                            // Combine three lists to get the final list
                            // FIXME: With this method, order of email list won't be kept
                            return name_email_list.concat(enclosed_email_list).concat(email_list);
                        } else {
                            // There is something wrong
                            return Array('');
                        }
                    }
                }
            })
        </script>
    </body>
</html> 